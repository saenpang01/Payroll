<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="style.css">
    
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT</h1>
            <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('upload', this)">üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            <button class="tab" onclick="showTab('reports', this)">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</button>
        </div>
        
        <div id="upload" class="tab-content active">
            <div class="upload-area" onclick="document.getElementById('csvFile').click()">
                <h3>üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h3>
                <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</p>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: CSV ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: sJobNo, sName, date, time)
                </p>
                <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileUpload(this)">
                <button class="btn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
            </div>
            
            <div id="uploadProgress" class="progress-container hidden">
                <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
                <p id="progressText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
            </div>
            
            <div id="uploadResult"></div>

            <div id="calculationSection" class="hidden" style="margin-top: 2rem;">
                 <h3>üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</h3>
                 <div class="form-grid">
                    <div class="form-group">
                        <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="calc_start_date">
                    </div>
                    <div class="form-group">
                        <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="calc_end_date">
                    </div>
                     <div class="form-group">
                        <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤ OT (‡∏ö‡∏≤‡∏ó/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á):</label>
                        <input type="number" id="otRate" value="50" min="0">
                    </div>
                 </div>
                 <button class="btn" onclick="calculateAndDisplaySummary()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ</button>
                 <div id="calculationResult" class="table-container" style="margin-top: 1rem;"></div>
            </div>
        </div>
        
        <div id="reports" class="tab-content">
            <h3>üìà ‡∏î‡∏π‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                    <select id="report_employee_select" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="report_start_date" class="form-control">
                </div>
                <div class="form-group">
                    <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="report_end_date" class="form-control">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                     <button class="btn" onclick="generateIndividualReport()">üîç ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
                </div>
            </div>
            <hr>
            <div id="individualReportResult" class="table-container">
                </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let employees = []; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Google Sheet
        let timeRecords = []; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß

        // --- Core Application Logic ---

        // 1. [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Google Sheet
       async function fetchAllEmployeesFromGoogleSheet() {
    const monthlySheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTPeXCWESqvqiaslhR8j-YvPBsPUi8RGDX8GKJ9w4XrUSbjrp2OotRG9zFz2oRdIFooVk7RVVKTD1cL/pub?gid=166039384&single=true&output=csv';
    const dailySheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTPeXCWESqvqiaslhR8j-YvPBsPUi8RGDX8GKJ9w4XrUSbjrp2OotRG9zFz2oRdIFooVk7RVVKTD1cL/pub?gid=1323019072&single=true&output=csv';

const processSheetData = (csvText, employeeType) => {
        const result = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        const data = result.data;
        const fields = result.meta.fields;

        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ)
        const idKey = fields.find(f => f && f.trim().toLowerCase() === 'id');
        const scanIdKey = fields.find(f => f && f.trim().toLowerCase() === 'scanid');
        const nameKey = fields.find(f => f && f.trim().toLowerCase() === 'name');
        const salaryKey = fields.find(f => f && f.trim().toLowerCase() === 'salary');
        
        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡πá‡∏à‡∏∞‡πÉ‡∏ä‡πâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£)
        const nicknameKey = fields.find(f => f && f.trim().toLowerCase() === 'nickname');
        const positionKey = fields.find(f => f && f.trim().toLowerCase() === 'position');
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (!idKey || !scanIdKey || !nameKey || !salaryKey) {
            console.error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (id, scanid, name, salary) ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï: ${employeeType}`);
            return [];
        }
        
        return data.map(emp => {
            const cleanEmployee = { ...emp }; 
            cleanEmployee.ID = emp[idKey]?.trim() || 'N/A';
            cleanEmployee.scanId = emp[scanIdKey]?.trim() || '';
            cleanEmployee.NAME = emp[nameKey]?.trim() || 'N/A';
            cleanEmployee.SALARY = emp[salaryKey]?.trim() || '0';
            cleanEmployee.NICKNAME = nicknameKey ? (emp[nicknameKey]?.trim() || '') : '';
            cleanEmployee.POSITION = positionKey ? (emp[positionKey]?.trim() || '') : '';
            // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏≠‡∏≠‡∏Å ---
            // cleanEmployee.‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° = socialSecurityKey ? (emp[socialSecurityKey]?.trim() || '‡πÑ‡∏°‡πà') : '‡πÑ‡∏°‡πà';
            cleanEmployee.type = employeeType;
            return cleanEmployee;
        });
    };

    try {
        const [monthlyResults, dailyResults] = await Promise.all([
            fetch(monthlySheetURL).then(response => {
                if (!response.ok) throw new Error(`Network response was not ok for monthly sheet`);
                return response.text();
            }),
            fetch(dailySheetURL).then(response => {
                if (!response.ok) throw new Error(`Network response was not ok for daily sheet`);
                return response.text();
            })
        ]);

        const monthlyEmployees = processSheetData(monthlyResults, '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
        const dailyEmployees = processSheetData(dailyResults, '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô');

        employees = [...monthlyEmployees, ...dailyEmployees];
        
        if(employees.length > 0){
            showMessage('upload', `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${employees.length} ‡∏Ñ‡∏ô‡∏à‡∏≤‡∏Å Google Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
            populateEmployeeDropdown();
        } else {
             showMessage('upload', `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏µ‡∏ï‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤`, 'error');
        }

    } catch (error) {
        console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet:', error);
        showMessage('upload', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Google Sheet', 'error');
    }
}

        // 2. [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV
function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const uploadProgress = document.getElementById('uploadProgress');
    uploadProgress.classList.remove('hidden');
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = '‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';

            const idHeader = results.meta.fields.find(h => h && h.trim() === 'sJobNo');
            const dateHeader = results.meta.fields.find(h => h.trim() === 'Date');
            const timeHeader = results.meta.fields.find(h => h.trim() === 'Time');

            if (!idHeader || !dateHeader || !timeHeader) {
                showMessage('uploadResult', `‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (sJobNo, Date, Time)`, 'error');
                uploadProgress.classList.add('hidden');
                return;
            }

            const scanEvents = results.data;
            const dailyRecords = {};
            scanEvents.forEach(scan => {
                const id = scan[idHeader];
                const date = scan[dateHeader];
                const time = scan[timeHeader];

                if (!id || !date || !time) return;

                const key = `${id.trim()}-${date.trim()}`;
                if (!dailyRecords[key]) {
                    dailyRecords[key] = { scanId: id.trim(), date: date.trim(), times: [time.trim()] };
                } else {
                    dailyRecords[key].times.push(time.trim());
                }
            });

            timeRecords = Object.values(dailyRecords).map(rec => {
                // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ---
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô .sort() ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ sort ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ
                rec.times = [...new Set(rec.times)].sort((timeA, timeB) => {
                    return new Date('1970/01/01 ' + timeA) - new Date('1970/01/01 ' + timeB);
                });
                // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
                return rec;
            });

            document.getElementById('uploadResult').innerHTML = `<div class="success">‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${timeRecords.length} ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>`;
            document.getElementById('calculationSection').classList.remove('hidden');
            setTimeout(() => { uploadProgress.classList.add('hidden'); }, 2000);
        },
        error: function(error) {
            showMessage('uploadResult', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV', 'error');
            uploadProgress.classList.add('hidden');
        }
    });
}

        // 3. [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏´‡∏•‡∏±‡∏Å)
function calculateWorkHoursAndOT(dailyTimeRecords, employee) {
    // [LOG] ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    // console.log(`[Debug Calc] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ID: ${dailyTimeRecords.scanId} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dailyTimeRecords.date} ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤:`, dailyTimeRecords.times);

    if (!dailyTimeRecords.times || dailyTimeRecords.times.length < 2) {
        return { workHours: 0, otHours: 0 };
    }

    const shifts = {
        '1': { name: '‡∏Å‡∏∞ 8 ‡πÇ‡∏°‡∏á', start: '08:00', end: '17:00' },
        '2': { name: '‡∏Å‡∏∞ 9 ‡πÇ‡∏°‡∏á', start: '09:00', end: '18:00' },
        '3': { name: '‡∏Å‡∏∞‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á', start: '12:00', end: '21:00' },
        '4': { name: '‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢ 3', start: '15:00', end: '24:00' }
    };

    const firstScanTime = dailyTimeRecords.times[0];
    const lastScanTime = dailyTimeRecords.times[dailyTimeRecords.times.length - 1];

    if (!firstScanTime || !lastScanTime) {
        return { workHours: 0, otHours: 0 };
    }

    // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ---
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Date object ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Ç‡∏∂‡πâ‡∏ô
    const timeIn = new Date('1970/01/01 ' + firstScanTime);
    let timeOut = new Date('1970/01/01 ' + lastScanTime);
    if (timeOut < timeIn) { timeOut.setDate(timeOut.getDate() + 1); }

    let totalWorkMillis = 0;
    for (let i = 0; i < dailyTimeRecords.times.length; i += 2) {
        if (dailyTimeRecords.times[i+1]) { 
            const scanIn = new Date('1970/01/01 ' + dailyTimeRecords.times[i]);
            let scanOut = new Date('1970/01/01 ' + dailyTimeRecords.times[i+1]);

            if (scanOut < scanIn) { scanOut.setDate(scanOut.getDate() + 1); }
            totalWorkMillis += (scanOut - scanIn);
        }
    }
    const workHours = totalWorkMillis / (1000 * 60 * 60);

    let bestShift = null;
    let smallestDiff = Infinity;
    for (const shiftKey in shifts) {
        const shift = shifts[shiftKey];
        const shiftStart = new Date('1970/01/01 ' + shift.start);
        const diff = Math.abs(timeIn - shiftStart);
        if (diff < smallestDiff) {
            smallestDiff = diff;
            bestShift = shift;
        }
    }

    if (!bestShift) {
        return { workHours: workHours, otHours: 0 };
    }

    const shiftStart = new Date('1970/01/01 ' + bestShift.start);
    let shiftEnd = new Date('1970/01/01 ' + (bestShift.end === '24:00' ? '23:59:59' : bestShift.end));
    // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

    if (shiftEnd < shiftStart) { shiftEnd.setDate(shiftEnd.getDate() + 1); }

    let otHours = 0;
    const earlyMillis = shiftStart - timeIn;
    if (earlyMillis > 0) {
        const earlyHours = earlyMillis / (1000 * 60 * 60);
        if (earlyHours >= 1) { otHours += Math.floor(earlyHours); }
    }

    const lateMillis = timeOut - shiftEnd;
    if (lateMillis > 0) {
        const lateHours = lateMillis / (1000 * 60 * 60);
        if (lateHours >= 1) { otHours += Math.floor(lateHours); }
    }

    return { workHours: workHours, otHours: otHours };
}

        // 4. [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
function calculateAndDisplaySummary() {
    const startDateInput = document.getElementById('calc_start_date').value;
    const endDateInput = document.getElementById('calc_end_date').value;
    const otRate = parseFloat(document.getElementById('otRate').value) || 50;

    if (!startDateInput || !endDateInput) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì');
        return;
    }

    const startDate = new Date(startDateInput);
    startDate.setHours(0, 0, 0, 0); 
    const endDate = new Date(endDateInput);
    endDate.setHours(0, 0, 0, 0); 

    const filteredRecords = timeRecords.filter(rec => {
        const recDate = convertToDate(rec.date);
        recDate.setHours(0, 0, 0, 0);
        return recDate >= startDate && recDate <= endDate;
    });
    
    if (filteredRecords.length === 0) {
        document.getElementById('calculationResult').innerHTML = '<p style="color: #cc0000; text-align: center; margin-top: 1rem;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
        return; 
    }

    const summary = {};
    filteredRecords.forEach(rec => {
        const employee = employees.find(emp => emp.scanId == rec.scanId); 
        if (employee) {
            if (!summary[employee.scanId]) {
                const cleanedSalary = employee.SALARY.replace(/[^\d.-]/g, '');
                summary[employee.scanId] = {
                    id: employee.ID,
                    name: employee.NAME,
                    nickname: employee.NICKNAME,
                    position: employee.POSITION,
                    type: employee.type,
                    salary: parseFloat(cleanedSalary) || 0,
                    totalWorkHours: 0,
                    totalOtHours: 0,
                    workDays: 0
                };
            }
            const { workHours, otHours } = calculateWorkHoursAndOT(rec, employee);
            summary[employee.scanId].totalWorkHours += workHours;
            summary[employee.scanId].totalOtHours += otHours;
            summary[employee.scanId].workDays++;
        }
    });

    let tableHTML = `
        <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (${formatDate(startDateInput)} - ${formatDate(endDateInput)})</h4>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                    <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                    <th>‡∏ä‡∏°.OT</th>
                    <th>‡∏Ñ‡πà‡∏≤ OT</th>
                    <th>‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                    <th>‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                </tr>
            </thead>
            <tbody>`;
    
    if (Object.keys(summary).length === 0) {
        tableHTML += '<tr><td colspan="8" style="text-align: center; color: #cc0000;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</td></tr>';
    } else {
        for(const scanId in summary){
            const data = summary[scanId];
            const otPay = data.totalOtHours * otRate;
            const baseSalary = data.type === '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' ? data.salary * data.workDays : data.salary;
            const totalPay = baseSalary + otPay;
            const displayName = `${data.name} (${data.nickname.toLowerCase()})`;

            tableHTML += `
                <tr>
                    <td>${data.id}</td>
                    <td>${displayName}</td>
                    <td>${data.position}</td>
                    <td style="text-align: center;">${data.workDays}</td>
                    <td style="text-align: center;">${data.totalOtHours}</td>
                    <td>${otPay.toLocaleString('th-TH')} ‡∏ø</td>
                    <td>${baseSalary.toLocaleString('th-TH')} ‡∏ø</td>
                    <td><strong>${totalPay.toLocaleString('th-TH')} ‡∏ø</strong></td>
                </tr>`;
        }
    }
    
    tableHTML += '</tbody></table>';
    document.getElementById('calculationResult').innerHTML = tableHTML;
}


        // 5. [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
function generateIndividualReport() {
    const empScanId = document.getElementById('report_employee_select').value;
    const startDateInput = document.getElementById('report_start_date').value;
    const endDateInput = document.getElementById('report_end_date').value;

    if (!empScanId || !startDateInput || !endDateInput) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
    }

    const startDate = new Date(startDateInput);
    startDate.setHours(0, 0, 0, 0);

    const endDate = new Date(endDateInput);
    endDate.setHours(0, 0, 0, 0);

    const employee = employees.find(emp => emp.scanId == empScanId); 

    const filteredRecords = timeRecords.filter(rec => {
        const recDate = convertToDate(rec.date);
        recDate.setHours(0, 0, 0, 0);
        return rec.scanId == empScanId && recDate >= startDate && recDate <= endDate;
    });

    if (!employee || filteredRecords.length === 0) {
        document.getElementById('individualReportResult').innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
        return;
    }

    let tableHTML = `
        <h4>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á: ${employee.NAME} (${formatDate(startDateInput)} - ${formatDate(endDateInput)})</h4>
        <table>
            <thead>
                <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT</th></tr>
            </thead>
            <tbody>`;

    let totalWork = 0, totalOT = 0;
    filteredRecords.forEach(rec => {
        const { workHours, otHours } = calculateWorkHoursAndOT(rec, employee);
        totalWork += workHours;
        totalOT += otHours;

        // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ---
        // ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Array 'times' ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        const displayTimeIn = rec.times && rec.times.length > 0 ? rec.times[0] : 'N/A';
        const displayTimeOut = rec.times && rec.times.length > 1 ? rec.times[rec.times.length - 1] : 'N/A';
        // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

        tableHTML += `
            <tr>
                <td>${formatDate(rec.date)}</td>
                <td>${displayTimeIn}</td>
                <td>${displayTimeOut}</td>
                <td>${isNaN(workHours) ? 'Error' : workHours.toFixed(2)}</td> <td>${otHours}</td>
            </tr>`;
    });

    tableHTML += `
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3"><strong>‡∏£‡∏ß‡∏°</strong></td>
                    <td><strong>${totalWork.toFixed(2)}</strong></td>
                    <td><strong>${totalOT}</strong></td>
                </tr>
            </tfoot>
        </table>`;

    document.getElementById('individualReportResult').innerHTML = tableHTML;
}


        // --- Utility and UI Functions ---
        function populateEmployeeDropdown() {
            const select = document.getElementById('report_employee_select');
            select.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>';

        // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ó‡∏±‡πâ‡∏á scanId ‡πÅ‡∏•‡∏∞ NAME)
            const validEmployees = employees.filter(emp => emp && emp.scanId && emp.NAME);

        // 2. ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô Dropdown
            validEmployees.sort((a, b) => a.NAME.localeCompare(b.NAME))
            .forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.scanId;
            option.textContent = `${emp.NAME} (${emp.type})`;
            select.appendChild(option);
            });
        }
        
        function convertToDate(dmyString) { // dd/mm/yyyy
            const parts = dmyString.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        
        function formatDate(dateString) {
            if(!dateString) return '';
            if(dateString.includes('/')) {
                 const parts = dateString.split('/');
                 return `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[2]}`;
            }
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function showTab(tabName, clickedButton) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            clickedButton.classList.add('active');
        }
        
        function showMessage(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const messageArea = container.querySelector('.success, .error, .info') || document.createElement('div');
            messageArea.className = type;
            messageArea.innerHTML = message;
            if (!messageArea.parentNode) {
                container.insertBefore(messageArea, container.firstChild);
            }
            setTimeout(() => { messageArea.remove(); }, 5000);
        }

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchAllEmployeesFromGoogleSheet();
        });
    </script>
</body>
</html>