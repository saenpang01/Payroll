<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="style.css">
    
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT</h1>
            <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('upload', this)">üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            <button class="tab" onclick="showTab('reports', this)">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</button>
        </div>
        
        <div id="upload" class="tab-content active">
            <div class="upload-area" onclick="document.getElementById('csvFile').click()">
                <h3>üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h3>
                <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</p>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: CSV ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: sJobNo, sName, date, time)
                </p>
                <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileUpload(this)">
                <button class="btn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
            </div>
            
            <div id="uploadProgress" class="progress-container hidden">
                <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
                <p id="progressText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
            </div>
            
            <div id="uploadResult"></div>

            <div id="calculationSection" class="hidden" style="margin-top: 2rem;">
                 <h3>üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</h3>
                 <div class="form-grid">
                    <div class="form-group">
                        <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="calc_start_date">
                    </div>
                    <div class="form-group">
                        <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="calc_end_date">
                    </div>
                     <div class="form-group">
                        <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤ OT (‡∏ö‡∏≤‡∏ó/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á):</label>
                        <input type="number" id="otRate" value="50" min="0">
                    </div>
                 </div>
                 <button class="btn" onclick="calculateAndDisplaySummary()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ</button>
                 <div id="calculationResult" class="table-container" style="margin-top: 1rem;"></div>
            </div>
        </div>
        
        <div id="reports" class="tab-content">
            <h3>üìà ‡∏î‡∏π‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                    <select id="report_employee_select" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="report_start_date" class="form-control">
                </div>
                <div class="form-group">
                    <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="report_end_date" class="form-control">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                     <button class="btn" onclick="generateIndividualReport()">üîç ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
                </div>
            </div>
            <hr>
            <div id="individualReportResult" class="table-container">
                </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        const CONSOLIDATION_WINDOW_HOURS = 3;
        const MAX_SHIFT_HOURS = 16;
        let employees = []; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Google Sheet
        let timeRecords = []; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß



        // 1. [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Google Sheet
       async function fetchAllEmployeesFromGoogleSheet() {
    const monthlySheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTPeXCWESqvqiaslhR8j-YvPBsPUi8RGDX8GKJ9w4XrUSbjrp2OotRG9zFz2oRdIFooVk7RVVKTD1cL/pub?gid=166039384&single=true&output=csv';
    const dailySheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTPeXCWESqvqiaslhR8j-YvPBsPUi8RGDX8GKJ9w4XrUSbjrp2OotRG9zFz2oRdIFooVk7RVVKTD1cL/pub?gid=1323019072&single=true&output=csv';

const processSheetData = (csvText, employeeType) => {
        const result = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        const data = result.data;
        const fields = result.meta.fields;

        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ)
        const idKey = fields.find(f => f && f.trim().toLowerCase() === 'id');
        const scanIdKey = fields.find(f => f && f.trim().toLowerCase() === 'scanid');
        const nameKey = fields.find(f => f && f.trim().toLowerCase() === 'name');
        const salaryKey = fields.find(f => f && f.trim().toLowerCase() === 'salary');
        
        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡πá‡∏à‡∏∞‡πÉ‡∏ä‡πâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£)
        const nicknameKey = fields.find(f => f && f.trim().toLowerCase() === 'nickname');
        const positionKey = fields.find(f => f && f.trim().toLowerCase() === 'position');
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (!idKey || !scanIdKey || !nameKey || !salaryKey) {
            console.error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (id, scanid, name, salary) ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï: ${employeeType}`);
            return [];
        }
        
        return data.map(emp => {
            const cleanEmployee = { ...emp }; 
            cleanEmployee.ID = emp[idKey]?.trim() || 'N/A';
            cleanEmployee.scanId = emp[scanIdKey]?.trim() || '';
            cleanEmployee.NAME = emp[nameKey]?.trim() || 'N/A';
            cleanEmployee.SALARY = emp[salaryKey]?.trim() || '0';
            cleanEmployee.NICKNAME = nicknameKey ? (emp[nicknameKey]?.trim() || '') : '';
            cleanEmployee.POSITION = positionKey ? (emp[positionKey]?.trim() || '') : '';
            // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏≠‡∏≠‡∏Å ---
            // cleanEmployee.‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° = socialSecurityKey ? (emp[socialSecurityKey]?.trim() || '‡πÑ‡∏°‡πà') : '‡πÑ‡∏°‡πà';
            cleanEmployee.type = employeeType;
            return cleanEmployee;
        });
    };

    try {
        const [monthlyResults, dailyResults] = await Promise.all([
            fetch(monthlySheetURL).then(response => {
                if (!response.ok) throw new Error(`Network response was not ok for monthly sheet`);
                return response.text();
            }),
            fetch(dailySheetURL).then(response => {
                if (!response.ok) throw new Error(`Network response was not ok for daily sheet`);
                return response.text();
            })
        ]);

        const monthlyEmployees = processSheetData(monthlyResults, '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
        const dailyEmployees = processSheetData(dailyResults, '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô');

        employees = [...monthlyEmployees, ...dailyEmployees];
        
        if(employees.length > 0){
            showMessage('upload', `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${employees.length} ‡∏Ñ‡∏ô‡∏à‡∏≤‡∏Å Google Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
            populateEmployeeDropdown();
        } else {
             showMessage('upload', `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏µ‡∏ï‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤`, 'error');
        }

    } catch (error) {
        console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet:', error);
        showMessage('upload', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Google Sheet', 'error');
    }
}

        // 2. [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV
function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const uploadProgress = document.getElementById('uploadProgress');
    uploadProgress.classList.remove('hidden');
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = '‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';

            const idHeader = results.meta.fields.find(h => h && h.trim() === 'sJobNo');
            const dateHeader = results.meta.fields.find(h => h.trim() === 'Date');
            const timeHeader = results.meta.fields.find(h => h.trim() === 'Time');

            if (!idHeader || !dateHeader || !timeHeader) {
                showMessage('uploadResult', `‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (sJobNo, Date, Time)`, 'error');
                uploadProgress.classList.add('hidden');
                return;
            }

            const rawScanEvents = results.data;
            
            const parseDateTime = (dateStr, timeStr) => {
                const dateParts = dateStr.split('/');
                const timeParts = timeStr.split(':');
                return new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1], timeParts[2]);
            };

            const sortedScans = rawScanEvents
                .filter(s => s[idHeader] && s[dateHeader] && s[timeHeader])
                .sort((a, b) => {
                    const aDateTime = parseDateTime(a[dateHeader], a[timeHeader]);
                    const bDateTime = parseDateTime(b[dateHeader], b[timeHeader]);
                    if (a[idHeader].trim() !== b[idHeader].trim()) {
                        return a[idHeader].trim().localeCompare(b[idHeader].trim());
                    }
                    return aDateTime.getTime() - bDateTime.getTime();
                });

            const consolidatedScans = [];
            for (let i = 0; i < sortedScans.length; i++) {
                let currentScan = sortedScans[i];
                while (
                    i + 1 < sortedScans.length &&
                    sortedScans[i+1][idHeader].trim() === currentScan[idHeader].trim()
                ) {
                    const currentScanTime = parseDateTime(currentScan[dateHeader], currentScan[timeHeader]);
                    const nextScanTime = parseDateTime(sortedScans[i+1][dateHeader], sortedScans[i+1][timeHeader]);
                    const diffHours = (nextScanTime - currentScanTime) / (1000 * 60 * 60);
                    if (diffHours < CONSOLIDATION_WINDOW_HOURS) {
                        i++; 
                        currentScan = sortedScans[i];
                    } else {
                        break;
                    }
                }
                consolidatedScans.push(currentScan);
            }

            const dailyRecords = {};
            const employeeLastRecordKey = {}; 
            
            consolidatedScans.forEach(scan => {
                const id = scan[idHeader].trim();
                const date = scan[dateHeader].trim();
                const time = scan[timeHeader].trim();
                
                const lastKey = employeeLastRecordKey[id];
                const lastRecord = lastKey ? dailyRecords[lastKey] : null;

                // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Logic ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà ---
                if (lastRecord && lastRecord.times.length % 2 !== 0) {
                    // ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    const lastScanTime = parseDateTime(lastRecord.date, lastRecord.times[lastRecord.times.length - 1]);
                    const currentScanTime = parseDateTime(date, time);
                    const diffHours = (currentScanTime - lastScanTime) / (1000 * 60 * 60);

                    if (diffHours > MAX_SHIFT_HOURS) {
                        // ‡∏ñ‡πâ‡∏≤‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                        lastRecord.incomplete = true; // ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
                        // ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                        const newKey = `${id}-${date}-${time}`; 
                        dailyRecords[newKey] = { scanId: id, date: date, times: [time], incomplete: false };
                        employeeLastRecordKey[id] = newKey;
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Å‡πá‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                        lastRecord.times.push(time);
                    }
                } else {
                    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
                    const newKey = `${id}-${date}-${time}`; 
                    dailyRecords[newKey] = { scanId: id, date: date, times: [time], incomplete: false };
                    employeeLastRecordKey[id] = newKey;
                }
                // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
            });
            
            // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏≠‡∏Å‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏•‡∏¢)
            Object.values(dailyRecords).forEach(rec => {
                if (rec.times.length % 2 !== 0) {
                    rec.incomplete = true;
                }
            });

            timeRecords = Object.values(dailyRecords).map(rec => {
                rec.times = [...new Set(rec.times)]; 
                return rec;
            });
            
            document.getElementById('uploadResult').innerHTML = `<div class="success">‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${timeRecords.length} ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>`;
            document.getElementById('calculationSection').classList.remove('hidden');
            setTimeout(() => { uploadProgress.classList.add('hidden'); }, 2000);
        },
        error: function(error) {
            showMessage('uploadResult', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV', 'error');
            uploadProgress.classList.add('hidden');
        }
    });
}

        // 3. [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏´‡∏•‡∏±‡∏Å)
function calculateWorkHoursAndOT(dailyTimeRecords, employee) {
    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å mark ‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ time stamp ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 2 ‡∏≠‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (dailyTimeRecords.incomplete || !dailyTimeRecords.times || dailyTimeRecords.times.length < 2) {
        return { workHours: 0, otHours: 0, incomplete: true };
    }

    const shifts = {
        '1': { name: '‡∏Å‡∏∞ 8 ‡πÇ‡∏°‡∏á', start: '08:00', end: '17:00' },
        '2': { name: '‡∏Å‡∏∞ 9 ‡πÇ‡∏°‡∏á', start: '09:00', end: '18:00' },
        '3': { name: '‡∏Å‡∏∞‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á', start: '12:00', end: '21:00' },
        '4': { name: '‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢ 3', start: '15:00', end: '24:00' }
    };

    const firstScanTime = dailyTimeRecords.times[0];
    const lastScanTime = dailyTimeRecords.times[dailyTimeRecords.times.length - 1];

    if (!firstScanTime || !lastScanTime) {
        return { workHours: 0, otHours: 0, incomplete: true };
    }

    const timeIn = new Date('1970/01/01 ' + firstScanTime);
    let timeOut = new Date('1970/01/01 ' + lastScanTime);
    if (timeOut < timeIn) { timeOut.setDate(timeOut.getDate() + 1); }

    let totalWorkMillis = 0;
    for (let i = 0; i < dailyTimeRecords.times.length; i += 2) {
        if (dailyTimeRecords.times[i+1]) { 
            const scanIn = new Date('1970/01/01 ' + dailyTimeRecords.times[i]);
            let scanOut = new Date('1970/01/01 ' + dailyTimeRecords.times[i+1]);
            if (scanOut < scanIn) { scanOut.setDate(scanOut.getDate() + 1); }
            totalWorkMillis += (scanOut - scanIn);
        }
    }
    const workHours = totalWorkMillis / (1000 * 60 * 60);

    let bestShift = null;
    let smallestDiff = Infinity;
    for (const shiftKey in shifts) {
        const shift = shifts[shiftKey];
        const shiftStart = new Date('1970/01/01 ' + shift.start);
        const diff = Math.abs(timeIn - shiftStart);
        if (diff < smallestDiff) {
            smallestDiff = diff;
            bestShift = shift;
        }
    }

    if (!bestShift) {
        return { workHours: workHours, otHours: 0, incomplete: false };
    }

    const shiftStart = new Date('1970/01/01 ' + bestShift.start);
    let shiftEnd = new Date('1970/01/01 ' + (bestShift.end === '24:00' ? '23:59:59' : bestShift.end));
    if (shiftEnd < shiftStart) { shiftEnd.setDate(shiftEnd.getDate() + 1); }

    let otHours = 0;
    const earlyMillis = shiftStart - timeIn;
    if (earlyMillis > 0) {
        const earlyHours = earlyMillis / (1000 * 60 * 60);
        if (earlyHours >= 1) { otHours += Math.floor(earlyHours); }
    }

    const lateMillis = timeOut - shiftEnd;
    if (lateMillis > 0) {
        const lateHours = lateMillis / (1000 * 60 * 60);
        if (lateHours >= 1) { otHours += Math.floor(lateHours); }
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° incomplete: false ‡πÉ‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
    return { workHours: workHours, otHours: otHours, incomplete: false };
}

        // 4. [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
function calculateAndDisplaySummary() {
    const startDateInput = document.getElementById('calc_start_date').value;
    const endDateInput = document.getElementById('calc_end_date').value;
    const otRate = parseFloat(document.getElementById('otRate').value) || 50;

    if (!startDateInput || !endDateInput) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì');
        return;
    }

    const reportStartDate = new Date(startDateInput);
    reportStartDate.setHours(0, 0, 0, 0); 
    const reportEndDate = new Date(endDateInput);
    reportEndDate.setHours(23, 59, 59, 999);

    const filteredRecords = timeRecords.filter(rec => {
        const workStartDate = convertToDate(rec.date);
        workStartDate.setHours(0, 0, 0, 0);
        const workEndDate = getWorkdayEndDate(rec);
        workEndDate.setHours(0, 0, 0, 0);
        return workStartDate <= reportEndDate && workEndDate >= reportStartDate;
    });
    
    if (filteredRecords.length === 0) {
        document.getElementById('calculationResult').innerHTML = '<p style="color: #cc0000; text-align: center; margin-top: 1rem;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
        return; 
    }

    const summary = {};
    filteredRecords.forEach(rec => {
        const employee = employees.find(emp => emp.scanId == rec.scanId); 
        if (employee) {
            if (!summary[employee.scanId]) {
                const cleanedSalary = employee.SALARY.replace(/[^\d.-]/g, '');
                summary[employee.scanId] = {
                    id: employee.ID,
                    name: employee.NAME,
                    nickname: employee.NICKNAME,
                    position: employee.POSITION,
                    type: employee.type,
                    salary: parseFloat(cleanedSalary) || 0,
                    totalWorkHours: 0,
                    totalOtHours: 0,
                    workDays: 0
                };
            }
            // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏ß‡∏Å‡∏Ñ‡πà‡∏≤ ---
            const { workHours, otHours, incomplete } = calculateWorkHoursAndOT(rec, employee);
            
            if (!incomplete) { // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                summary[employee.scanId].totalWorkHours += workHours;
                summary[employee.scanId].totalOtHours += otHours;
                summary[employee.scanId].workDays++;
            }
        }
    });

    let tableHTML = `
        <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (${formatDate(startDateInput)} - ${formatDate(endDateInput)})</h4>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                    <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                    <th>‡∏ä‡∏°.OT</th>
                    <th>‡∏Ñ‡πà‡∏≤ OT</th>
                    <th>‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                    <th>‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                </tr>
            </thead>
            <tbody>`;
    
    if (Object.keys(summary).length === 0) {
        tableHTML += '<tr><td colspan="8" style="text-align: center; color: #cc0000;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</td></tr>';
    } else {
        for(const scanId in summary){
            const data = summary[scanId];
            const otPay = data.totalOtHours * otRate;
            const baseSalary = data.type === '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' ? data.salary * data.workDays : data.salary;
            const totalPay = baseSalary + otPay;
            const displayName = `${data.name} (${data.nickname.toLowerCase()})`;

            // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ñ‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            if (data.workDays === 0 && filteredRecords.some(r => r.scanId === scanId)) {
                 tableHTML += `
                    <tr class="row-incomplete">
                        <td>${data.id}</td>
                        <td>${displayName}</td>
                        <td>${data.position}</td>
                        <td colspan="5" style="text-align: center;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</td>
                    </tr>`;
            } else if (data.workDays > 0) {
                tableHTML += `
                    <tr>
                        <td>${data.id}</td>
                        <td>${displayName}</td>
                        <td>${data.position}</td>
                        <td style="text-align: center;">${data.workDays}</td>
                        <td style="text-align: center;">${data.totalOtHours}</td>
                        <td>${otPay.toLocaleString('th-TH')} ‡∏ø</td>
                        <td>${baseSalary.toLocaleString('th-TH')} ‡∏ø</td>
                        <td><strong>${totalPay.toLocaleString('th-TH')} ‡∏ø</strong></td>
                    </tr>`;
            }
        }
    }
    
    tableHTML += '</tbody></table>';
    document.getElementById('calculationResult').innerHTML = tableHTML;
}

function generateIndividualReport() {
    const empScanId = document.getElementById('report_employee_select').value;
    const startDateInput = document.getElementById('report_start_date').value;
    const endDateInput = document.getElementById('report_end_date').value;

    if (!empScanId || !startDateInput || !endDateInput) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
    }

    const reportStartDate = new Date(startDateInput);
    reportStartDate.setHours(0, 0, 0, 0);
    const reportEndDate = new Date(endDateInput);
    reportEndDate.setHours(23, 59, 59, 999);

    const employee = employees.find(emp => emp.scanId == empScanId); 

    const filteredRecords = timeRecords.filter(rec => {
        if (rec.scanId != empScanId) return false;
        const workStartDate = convertToDate(rec.date);
        workStartDate.setHours(0, 0, 0, 0);
        const workEndDate = getWorkdayEndDate(rec);
        workEndDate.setHours(0, 0, 0, 0);
        return workStartDate <= reportEndDate && workEndDate >= reportStartDate;
    });

    if (!employee || filteredRecords.length === 0) {
        document.getElementById('individualReportResult').innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
        return;
    }
    
    let tableHTML = `
        <h4>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á: ${employee.NAME} (${formatDate(startDateInput)} - ${formatDate(endDateInput)})</h4>
        <table>
            <thead>
                <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT</th></tr>
            </thead>
            <tbody>`;

    let totalWork = 0, totalOT = 0;
    filteredRecords.forEach(rec => {
        const { workHours, otHours, incomplete } = calculateWorkHoursAndOT(rec, employee);

        // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏ß‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
        if (incomplete) {
            const displayTimeIn = rec.times && rec.times.length > 0 ? rec.times[0] : 'N/A';
            const displayTimeOut = rec.times && rec.times.length > 1 ? rec.times[rec.times.length - 1] : 'N/A';
            tableHTML += `
                <tr class="row-incomplete">
                    <td>${formatDate(rec.date)}</td>
                    <td>${displayTimeIn}</td>
                    <td>${displayTimeOut}</td>
                    <td colspan="2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</td>
                </tr>`;
        } else {
            totalWork += workHours;
            totalOT += otHours;
            const displayTimeIn = rec.times[0];
            const displayTimeOut = rec.times[rec.times.length - 1];
            tableHTML += `
                <tr>
                    <td>${formatDate(rec.date)}</td>
                    <td>${displayTimeIn}</td>
                    <td>${displayTimeOut}</td>
                    <td>${workHours.toFixed(2)}</td>
                    <td>${otHours}</td>
                </tr>`;
        }
        // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
    });

    tableHTML += `
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3"><strong>‡∏£‡∏ß‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)</strong></td>
                    <td><strong>${totalWork.toFixed(2)}</strong></td>
                    <td><strong>${totalOT}</strong></td>
                </tr>
            </tfoot>
        </table>`;

    document.getElementById('individualReportResult').innerHTML = tableHTML;
}


        // --- Utility and UI Functions ---
        function populateEmployeeDropdown() {
            const select = document.getElementById('report_employee_select');
            select.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>';

        // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ó‡∏±‡πâ‡∏á scanId ‡πÅ‡∏•‡∏∞ NAME)
            const validEmployees = employees.filter(emp => emp && emp.scanId && emp.NAME);

        // 2. ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô Dropdown
            validEmployees.sort((a, b) => a.NAME.localeCompare(b.NAME))
            .forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.scanId;
            option.textContent = `${emp.NAME} (${emp.type})`;
            select.appendChild(option);
            });
        }
        
        function getWorkdayEndDate(record) {
            const startDate = convertToDate(record.date);
            if (!record.times || record.times.length < 2) {
                return startDate; // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
            }
            const timeIn = new Date('1970/01/01 ' + record.times[0]);
            const timeOut = new Date('1970/01/01 ' + record.times[record.times.length - 1]);

            if (timeOut < timeIn) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 1); // ‡∏ö‡∏ß‡∏Å‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å 1 ‡∏ß‡∏±‡∏ô
                return endDate;
            }
            return startDate; // ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
        }

        function convertToDate(dmyString) { // dd/mm/yyyy
            const parts = dmyString.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        
        function formatDate(dateString) {
            if(!dateString) return '';
            if(dateString.includes('/')) {
                 const parts = dateString.split('/');
                 return `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[2]}`;
            }
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function showTab(tabName, clickedButton) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            clickedButton.classList.add('active');
        }
        
        function showMessage(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const messageArea = container.querySelector('.success, .error, .info') || document.createElement('div');
            messageArea.className = type;
            messageArea.innerHTML = message;
            if (!messageArea.parentNode) {
                container.insertBefore(messageArea, container.firstChild);
            }
            setTimeout(() => { messageArea.remove(); }, 5000);
        }

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchAllEmployeesFromGoogleSheet();
        });
    </script>
</body>
</html>