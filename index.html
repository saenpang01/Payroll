<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Employee Card Styles */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 2rem;
        }
        
        .employee-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .employee-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border-left-color: #764ba2;
        }
        
        .employee-card.monthly {
            border-left-color: #28a745;
        }
        
        .employee-card.daily {
            border-left-color: #ffc107;
        }
        
        .employee-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .employee-position {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .employee-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .employee-type.monthly {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .employee-type.daily {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: white;
        }
        
        .employee-stats {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }
        
        .employee-stats span {
            color: #667eea;
            font-weight: 600;
        }
        
        /* Summary Section Improvements */
        .summary-section {
            margin-bottom: 30px;
        }
        
        .summary-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 3px;
        }
        
        .summary-tab {
            flex: 1;
            padding: 10px 15px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
        }
        
        .summary-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .summary-tab.monthly.active {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .summary-tab.daily.active {
            background: linear-gradient(135deg, #ffc107, #ff9800);
        }
        
        .summary-content {
            display: none;
        }
        
        .summary-content.active {
            display: block;
        }
        
        /* Enhanced table styling */
        .clickable-name {
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
            transition: all 0.3s ease;
        }
        
        .clickable-name:hover {
            color: #764ba2;
            transform: scale(1.02);
        }
        
        /* Modal for employee details */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            /* VIBE-CODE FIX: ‡πÄ‡∏û‡∏¥‡πà‡∏° overflow ‡πÅ‡∏•‡∏∞ padding ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
            overflow-y: auto;
            padding: 2rem 0;
        }
        
        .modal-content {
            background-color: white;
            /* VIBE-CODE FIX: ‡∏õ‡∏£‡∏±‡∏ö margin ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° flexbox */
            margin: 0 auto; 
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalFadeIn 0.3s ease;
            display: flex;
            flex-direction: column;
            max-height: 90vh; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î */
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
            /* VIBE-CODE FIX: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ scroll ‡πÑ‡∏î‡πâ */
            overflow-y: auto;
        }
        
        .close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            transition: all 0.3s ease;
        }
        
        .close:hover {
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT</h1>
            <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ OT</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('upload', this)">üìù ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î</button>
            <button class="tab" onclick="showTab('reports', this)">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</button>
        </div>
        
        <div id="upload" class="tab-content active">
            <div class="upload-area" onclick="document.getElementById('csvFile').click()">
                <h3>üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h3>
                <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</p>
                <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileUpload(this)">
                <button class="btn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
            </div>
            
            <div id="uploadProgress" class="progress-container hidden">
                <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
                <p id="progressText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
            </div>
            
            <div id="uploadResult"></div>

            <div id="calculationSection" class="hidden" style="margin-top: 2rem;">
                 <h3>üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</h3>
                 <div class="form-grid">
                    <div class="form-group">
                        <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="calc_start_date">
                    </div>
                    <div class="form-group">
                        <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="calc_end_date">
                    </div>
                     <div class="form-group">
                        <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤ OT (‡∏ö‡∏≤‡∏ó/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á):</label>
                        <input type="number" id="otRate" value="50" min="0">
                    </div>
                 </div>
                 <button class="btn" onclick="calculateAndDisplaySummary()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ</button>
                 
                 <div id="calculationResult" class="table-container summary-section" style="margin-top: 1rem;">
                 </div>
            </div>
        </div>
        
        <div id="reports" class="tab-content">
            <h3>üìà ‡∏î‡∏π‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                    <select id="report_employee_select" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="report_start_date" class="form-control">
                </div>
                <div class="form-group">
                    <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="report_end_date" class="form-control">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                     <button class="btn" onclick="generateIndividualReport()">üîç ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
                </div>
            </div>
            <hr>
            <div id="individualReportResult" class="table-container"></div>
        </div>

        <div id="errorReportContainer" style="margin-top: 2rem;"></div>
    </div>

    <!-- Employee Detail Modal -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalEmployeeName">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                <button class="close" onclick="closeEmployeeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalEmployeeDetails">
                <!-- Employee details will be loaded here -->
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Additional functions for enhanced UI
        function displaySummaryWithTabs(summaryData, startDate, endDate, otRate) {
            const monthlyEmployees = Object.values(summaryData).filter(emp => emp.type === '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
            const dailyEmployees = Object.values(summaryData).filter(emp => emp.type === '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô');
            
            let tabsHTML = `
                <div class="summary-tabs">
                    <button class="summary-tab active" onclick="showSummaryTab('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${Object.keys(summaryData).length})</button>
                    <button class="summary-tab monthly" onclick="showSummaryTab('monthly', this)">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (${monthlyEmployees.length})</button>
                    <button class="summary-tab daily" onclick="showSummaryTab('daily', this)">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (${dailyEmployees.length})</button>
                </div>`;
            
            tabsHTML += `<div id="summary-all" class="summary-content active">`;
            tabsHTML += generateSummaryTable(Object.values(summaryData), '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', startDate, endDate, otRate);
            tabsHTML += `</div>`;
            
            tabsHTML += `<div id="summary-monthly" class="summary-content">`;
            tabsHTML += generateSummaryTable(monthlyEmployees, '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', startDate, endDate, otRate);
            tabsHTML += `</div>`;
            
            tabsHTML += `<div id="summary-daily" class="summary-content">`;
            tabsHTML += generateSummaryTable(dailyEmployees, '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô', startDate, endDate, otRate);
            tabsHTML += `</div>`;
            
            return tabsHTML;
        }
        
        function generateSummaryTable(employees, title, startDate, endDate, otRate) {
            if (employees.length === 0) {
                return `<p style="text-align: center; color: #666; margin: 2rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•${title}</p>`;
            }
            
            let tableHTML = `
                <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î - ${title} (${formatDate(startDate)} - ${formatDate(endDate)})</h4>
                <table>
                    <thead>
                        <tr><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th><th>‡∏ä‡∏°.OT</th><th>‡∏Ñ‡πà‡∏≤ OT</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th></tr>
                    </thead>
                    <tbody>`;
            
            let totalOtPay = 0, totalSalary = 0, totalPay = 0;
            
            employees.sort((a,b) => a.id.localeCompare(b.id)).forEach(data => {
                const otPay = data.totalOtHours * otRate;
                const baseSalary = data.type === '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' ? data.salary * data.workDays : data.salary;
                const employeeTotalPay = baseSalary + otPay;
                const displayName = `${data.name} (${data.nickname.toLowerCase()})`;
                
                totalOtPay += otPay;
                totalSalary += baseSalary;
                totalPay += employeeTotalPay;
                
                tableHTML += `
                    <tr>
                        <td>${data.id}</td>
                        <td><span class="clickable-name" onclick="showEmployeeDetail('${data.id}', '${startDate}', '${endDate}')">${displayName}</span></td>
                        <td>${data.position}</td>
                        <td style="text-align: center;">${data.workDays}</td>
                        <td style="text-align: center;">${data.totalOtHours}</td>
                        <td>${otPay.toLocaleString('th-TH')} ‡∏ø</td>
                        <td>${baseSalary.toLocaleString('th-TH')} ‡∏ø</td>
                        <td><strong>${employeeTotalPay.toLocaleString('th-TH')} ‡∏ø</strong></td>
                    </tr>`;
            });
            
            tableHTML += `
                    <tr style="background: #f8f9fa; font-weight: bold;">
                        <td colspan="5"><strong>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</strong></td>
                        <td><strong>${totalOtPay.toLocaleString('th-TH')} ‡∏ø</strong></td>
                        <td><strong>${totalSalary.toLocaleString('th-TH')} ‡∏ø</strong></td>
                        <td><strong style="color: #007bff; font-size: 1.1em;">${totalPay.toLocaleString('th-TH')} ‡∏ø</strong></td>
                    </tr>
                </tbody></table>`;
            
            return tableHTML;
        }
        
        function showSummaryTab(tabType, clickedButton) {
            document.querySelectorAll('.summary-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.summary-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('summary-' + tabType).classList.add('active');
            clickedButton.classList.add('active');
        }
        
        function showEmployeeDetail(employeeId, startDate, endDate) {
            // Find employee by ID (not scanId)
            const employee = employees.find(emp => emp.ID === employeeId);
            if (!employee) return;
            
            // Generate individual report in modal
            generateEmployeeDetailModal(employee, startDate, endDate);
        }
        
        function generateEmployeeDetailModal(employee, startDate, endDate) {
            const reportStartDate = new Date(startDate);
            reportStartDate.setHours(0, 0, 0, 0);
            const reportEndDate = new Date(endDate);
            reportEndDate.setHours(23, 59, 59, 999);
            
            const filteredRecords = timeRecords.filter(rec => {
                if (rec.scanId != employee.scanId) return false;
                const workDate = convertToDate(rec.date);
                workDate.setHours(0,0,0,0);
                return workDate >= reportStartDate && workDate <= reportEndDate;
            });
            
            if (filteredRecords.length === 0) {
                document.getElementById('modalEmployeeDetails').innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                document.getElementById('modalEmployeeName').textContent = `${employee.NAME} - ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;
                document.getElementById('employeeModal').style.display = 'block';
                return;
            }
            
            let detailHTML = `
                <div class="employee-info" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>‡∏£‡∏´‡∏±‡∏™:</strong> ${employee.ID}</div>
                        <div><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</strong> ${employee.NICKNAME}</div>
                        <div><strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${employee.POSITION}</div>
                        <div><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> <span class="employee-type ${employee.type === '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' ? 'monthly' : 'daily'}">${employee.type}</span></div>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á OT</th></tr>
                    </thead>
                    <tbody>`;
            
            let totalWork = 0, totalOT = 0;
            filteredRecords.forEach(rec => {
                const { workHours, otHours, otWarning } = calculateWorkHoursAndOT(rec, employee);
                
                if (rec.incomplete) {
                    let timeInText = 'N/A';
                    let timeOutText = 'N/A';
                    
                    if (rec.problem === 'Forgot OUT') {
                        timeInText = rec.times[0];
                        timeOutText = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏≠‡∏Å';
                    } else if (rec.problem === 'Forgot IN') {
                        timeInText = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤';
                        timeOutText = rec.times[0];
                    }
                    
                    detailHTML += `
                        <tr class="row-incomplete">
                            <td>${formatDate(rec.date)}</td>
                            <td>${timeInText}</td>
                            <td>${timeOutText}</td>
                            <td style="text-align: center;">-</td>
                            <td style="text-align: center;">-</td>
                        </tr>`;
                } else {
                    totalWork += workHours;
                    totalOT += otHours;
                    detailHTML += `
                        <tr>
                            <td>${formatDate(rec.date)}</td>
                            <td>${rec.times[0]}</td>
                            <td>${rec.times[1]}</td>
                            <td>${workHours.toFixed(2)}</td>
                            <td class="${otWarning ? 'ot-warning' : ''}" title="${otWarning ? '‡∏ó‡∏≥ OT ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' : ''}">${otHours}</td>
                        </tr>`;
                }
            });
            
            detailHTML += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>‡∏£‡∏ß‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)</strong></td>
                            <td><strong>${totalWork.toFixed(2)}</strong></td>
                            <td><strong>${totalOT}</strong></td>
                        </tr>
                    </tfoot>
                </table>`;
            
            document.getElementById('modalEmployeeName').textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${employee.NAME}`;
            document.getElementById('modalEmployeeDetails').innerHTML = detailHTML;
            document.getElementById('employeeModal').style.display = 'block';
        }
        
        function closeEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'none';
        }
        
        // Enhanced calculateAndDisplaySummary function
        function calculateAndDisplaySummary() {
            const startDateInput = document.getElementById('calc_start_date').value;
            const endDateInput = document.getElementById('calc_end_date').value;
            const otRate = parseFloat(document.getElementById('otRate').value) || 50;

            if (!startDateInput || !endDateInput) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏î');
                return;
            }

            const reportStartDate = new Date(startDateInput);
            reportStartDate.setHours(0, 0, 0, 0); 
            const reportEndDate = new Date(endDateInput);
            reportEndDate.setHours(23, 59, 59, 999);

            const filteredRecords = timeRecords.filter(rec => {
                const workDate = convertToDate(rec.date);
                workDate.setHours(0,0,0,0);
                return workDate >= reportStartDate && workDate <= reportEndDate;
            });
            
            if (filteredRecords.length === 0) {
                document.getElementById('calculationResult').innerHTML = '<p style="color: #cc0000; text-align: center; margin-top: 1rem;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                return; 
            }

            const summary = {};
            filteredRecords.forEach(rec => {
                const employee = employees.find(emp => emp.scanId == rec.scanId); 
                if (employee) {
                    if (!summary[employee.scanId]) {
                        summary[employee.scanId] = {
                            id: employee.ID, name: employee.NAME, nickname: employee.NICKNAME, position: employee.POSITION,
                            type: employee.type, salary: parseFloat(employee.SALARY.replace(/[^\d.-]/g, '')) || 0,
                            totalOtHours: 0, workDays: 0
                        };
                    }
                    const { otHours } = calculateWorkHoursAndOT(rec, employee);
                    summary[employee.scanId].totalOtHours += otHours;
                    summary[employee.scanId].workDays++;
                }
            });

            const summaryHTML = displaySummaryWithTabs(summary, startDateInput, endDateInput, otRate);
            document.getElementById('calculationResult').innerHTML = summaryHTML;
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('employeeModal');
            if (event.target == modal) {
                closeEmployeeModal();
            }
        }
    </script>
</body>
</html>