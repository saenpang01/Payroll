<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="style.css">
    
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('upload', this)">üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="tab" onclick="showTab('employees', this)">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
            <button class="tab" onclick="showTab('calculate', this)">üí∞ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            <button class="tab" onclick="showTab('payroll', this)">üè¶ ‡πÑ‡∏ü‡∏•‡πå‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button>
            <button class="tab" onclick="showTab('payslips', this)">üìÑ ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            <button class="tab" onclick="showTab('reports', this)">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        </div>
        
        <div id="upload" class="tab-content active">
            <div class="upload-area" onclick="document.getElementById('csvFile').click()">
                <h3>üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h3>
                <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</p>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: CSV ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: sJobNo, sName, date, time)
                </p>
                <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileUpload(this)">
                <button class="btn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
            </div>
            
            <div id="uploadProgress" class="progress-container hidden">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <p id="progressText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
            </div>
            
            <div id="uploadResult"></div>
        </div>
        
        <div id="employees" class="tab-content">
            <div class="form-grid">
                <div class="form-group">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                    <input type="text" id="empId" placeholder="EMP001">
                </div>
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                    <input type="text" id="empName" placeholder="‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
                </div>
                <div class="form-group">
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                    <select id="empType">
                        <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô:</label>
                    <input type="number" id="empSalary" placeholder="30000">
                </div>
                <div class="form-group">
                    <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
                    <input type="email" id="empEmail" placeholder="employee@company.com">
                </div>
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</label>
                    <input type="text" id="empAccount" placeholder="123-4-56789-0">
                </div>
            </div>
            
            <div class="form-group">
                <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô:</label>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="time" id="workStart" value="08:00">
                    <span>‡∏ñ‡∏∂‡∏á</span>
                    <input type="time" id="workEnd" value="17:00">
                    <span>‡∏û‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</span>
                    <input type="number" id="lunchBreak" value="60" min="0" max="120" style="width: 80px;">
                    <span>‡∏ô‡∏≤‡∏ó‡∏µ</span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="addEmployee()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                <button class="btn btn-secondary" onclick="loadSampleEmployees()">üìã ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>‡∏£‡∏´‡∏±‡∏™</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô</th>
                            <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                            <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="calculate" class="tab-content">
            <div class="form-grid">
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                    <input type="month" id="calculate_month" value="">
                </div>
                <div class="form-group">
                    <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤ OT (‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á):</label>
                    <input type="number" id="otRate" value="50" min="0">
                </div>
                <div class="form-group">
                    <label>‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå:</label>
                    <select id="weekendDays" multiple>
                        <option value="0">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
                        <option value="1">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                        <option value="2">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                        <option value="3">‡∏û‡∏∏‡∏ò</option>
                        <option value="4">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                        <option value="5">‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                        <option value="6" selected>‡πÄ‡∏™‡∏≤‡∏£‡πå</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="calculatePayroll()">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="btn btn-success" onclick="exportCalculation()">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            </div>
            
            <div id="calculationResult"></div>
        </div>
        
        <div id="payroll" class="tab-content">
            <div class="form-grid">
                <div class="form-group">
                    <label>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</label>
                    <select id="bankType">
                        <option value="kbank">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option>
                        <option value="scb">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option>
                        <option value="bbl">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
                        <option value="tmb">‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï</option>
                        <option value="ktb">‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</option>
                        <option value="generic">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</label>
                    <input type="text" id="companyAccount" placeholder="123-4-56789-0">
                </div>
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</label>
                    <input type="text" id="companyName" placeholder="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC ‡∏à‡∏≥‡∏Å‡∏±‡∏î">
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="generateBankFile()">üè¶ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button>
                <button class="btn btn-secondary" onclick="previewBankFile()">üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå</button>
            </div>
            
            <div id="bankFileResult"></div>
        </div>
        
        <div id="payslips" class="tab-content">
            <div class="form-grid">
                <div class="form-group">
                    <label>‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏™‡∏•‡∏¥‡∏õ:</label>
                    <select id="payslipTemplate">
                        <option value="standard">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</option>
                        <option value="detailed">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</option>
                        <option value="simple">‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (URL):</label>
                    <input type="url" id="companyLogo" placeholder="https://example.com/logo.png">
                </div>
                <div class="form-group">
                    <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</label>
                    <textarea id="companyAddress" rows="3" placeholder="123 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡πÅ‡∏Ç‡∏ß‡∏á‡∏Ñ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ô ‡πÄ‡∏Ç‡∏ï‡∏Ñ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10110"></textarea>
                </div>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="autoEmail" checked>
                    ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </label>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="generatePayslips()">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="btn btn-success" onclick="sendAllPayslips()">üìß ‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
            </div>
            
            <div id="payslipResult"></div>
        </div>
        
        <div id="reports" class="tab-content">
            <h3>üí∞ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                    <input type="month" id="report_month">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                     <button class="btn" onclick="calculatePayroll()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>
            </div>
            <hr>
            <div class="report-summary">
                 <div class="card"><h3>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><div class="value" id="totalEmployees">0 ‡∏Ñ‡∏ô</div></div>
                 <div class="card"><h3>‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h3><div class="value" id="totalSalary">0.00 ‡∏ö‡∏≤‡∏ó</div></div>
                 <div class="card"><h3>OT ‡∏£‡∏ß‡∏°</h3><div class="value" id="totalOT">0 ‡∏ä‡∏°.</div></div>
                 <div class="card"><h3>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3><div class="value" id="avgWorkDays">0 ‡∏ß‡∏±‡∏ô</div></div>
            </div>
            
            <div class="table-container">
                <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô</h3>
                <table>
                    <thead>
                        <tr>
                            <th>‡∏£‡∏´‡∏±‡∏™</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏ä‡∏°.‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏ä‡∏°.OT</th>
                            <th>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                            <th>‡∏Ñ‡πà‡∏≤OT</th>
                            <th>‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="reportTable">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let employees = [];
        let timeRecords = [];
        let payrollResults = [];

        // --- Tab Management ---
        function showTab(tabName, clickedButton) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tabContent = document.getElementById(tabName);
            if (tabContent) tabContent.classList.add('active');
            if (clickedButton) clickedButton.classList.add('active');
            if (tabName === 'employees') {
                updateEmployeeTable();
            } else if (tabName === 'reports') {
                updateReportSummary();
            }
        }

        // --- File Upload ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (uploadProgress) uploadProgress.classList.remove('hidden');
            if (progressFill) progressFill.style.width = '0%';
            if (progressText) progressText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (progressFill) progressFill.style.width = '100%';
                    if (progressText) progressText.textContent = '‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';

                    const scanEvents = results.data;
                    const findHeader = (fields, names) => fields.find(h => h && names.some(n => h.trim().toLowerCase().includes(n)));
                    
                    const idHeader = findHeader(results.meta.fields, ['sjobno', 'job', 'id']);
                    const nameHeader = findHeader(results.meta.fields, ['sname', 'name']);
                    const dateHeader = findHeader(results.meta.fields, ['date']);
                    const timeHeader = findHeader(results.meta.fields, ['time']);
                    
                    if (!idHeader || !dateHeader || !timeHeader) {
                        showMessage('uploadResult', '‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (sJobNo, Date, Time)', 'error');
                        if (uploadProgress) uploadProgress.classList.add('hidden');
                        return;
                    }

                    const dailyRecords = {};
                    scanEvents.forEach(scan => {
                        const id = scan[idHeader];
                        const date = scan[dateHeader];
                        const time = scan[timeHeader];
                        
                        if (!id || id.trim() === '0' || id.trim().toLowerCase() === 'null' || !date || !time) return;
                        
                        const key = `${id}-${date}`;
                        if (!dailyRecords[key]) {
                            dailyRecords[key] = { 
                                id: id.trim(), 
                                name: (scan[nameHeader] || '').trim(), 
                                date: date.trim(), 
                                times: [time.trim()] 
                            };
                        } else {
                            dailyRecords[key].times.push(time.trim());
                        }
                    });

                    timeRecords = Object.values(dailyRecords).map(rec => {
                        rec.times.sort((timeA, timeB) => new Date('1970/01/01 ' + timeA) - new Date('1970/01/01 ' + timeB));
                        rec.timeIn = rec.times[0];
                        rec.timeOut = rec.times[rec.times.length - 1];
                        return rec;
                    });

                    displayUploadResults(timeRecords);
                    
                    setTimeout(() => {
                        if (uploadProgress) uploadProgress.classList.add('hidden');
                    }, 2000);
                },
                error: function(error) {
                    showMessage('uploadResult', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV', 'error');
                    if (uploadProgress) uploadProgress.classList.add('hidden');
                }
            });
        }
        
        function displayUploadResults(records) {
            const resultDiv = document.getElementById('uploadResult');
            if (!resultDiv) return;
            
            if (records.length === 0) {
                showMessage('uploadResult', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'info');
                return;
            }

            let tableHTML = `
                <div class="success">‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${records.length} ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                <div class="table-container" style="margin-top: 20px;">
                    <h3>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (‡πÅ‡∏™‡∏î‡∏á 10 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡πÅ‡∏Å‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            records.slice(0, 10).forEach(rec => {
                tableHTML += `
                    <tr>
                        <td>${rec.id}</td><td>${rec.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td><td>${rec.date}</td><td>${rec.timeIn}</td><td>${rec.timeOut}</td><td>${rec.times.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</td>
                    </tr>`;
            });
            
            tableHTML += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" style="text-align: center; font-weight: bold;">‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ${Math.min(10, records.length)} ‡πÅ‡∏ñ‡∏ß ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${records.length} ‡πÅ‡∏ñ‡∏ß</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>`;
            resultDiv.innerHTML = tableHTML;
        }

        // --- Employee Management ---
        function addEmployee() {
            const empId = document.getElementById('empId').value.trim();
            const empName = document.getElementById('empName').value.trim();
            const empSalary = document.getElementById('empSalary').value || 0;
            const empType = document.getElementById('empType').value;
            const empEmail = document.getElementById('empEmail').value.trim();
            const empAccount = document.getElementById('empAccount').value.trim();

            if (!empId || !empName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                return;
            }

            const employeeData = { id: empId, name: empName, salary: parseFloat(empSalary), type: empType, email: empEmail, account: empAccount };

            const existingIndex = employees.findIndex(emp => emp.id === empId);
            if (existingIndex > -1) {
                employees[existingIndex] = employeeData;
                showMessage('employees', `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${empName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
            } else {
                employees.push(employeeData);
                showMessage('employees', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${empName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
            }

            updateEmployeeTable();
            clearEmployeeForm();
            saveEmployeesToLocal();
        }

        function saveEmployeesToLocal() {
            localStorage.setItem('payroll_employees', JSON.stringify(employees));
        }

        function loadEmployeesFromLocal() {
            const employeesData = localStorage.getItem('payroll_employees');
            if (employeesData) {
                employees = JSON.parse(employeesData);
            }
        }

        function clearEmployeeForm() {
            document.getElementById('empId').value = '';
            document.getElementById('empName').value = '';
            document.getElementById('empSalary').value = '';
            document.getElementById('empType').value = 'monthly';
            document.getElementById('empEmail').value = '';
            document.getElementById('empAccount').value = '';
        }

        function updateEmployeeTable() {
            const tableBody = document.getElementById('employeeTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (employees.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</td></tr>';
                return;
            }

            employees.forEach((emp, index) => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${emp.id}</td><td>${emp.name}</td><td>${emp.type === 'monthly' ? '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô'}</td><td>${emp.salary.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td><td>${emp.email || '-'}</td><td>${emp.account || '-'}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editEmployee(${index})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="btn btn-danger" onclick="deleteEmployee(${index})" style="font-size: 12px; padding: 4px 8px;">üóëÔ∏è ‡∏•‡∏ö</button>
                    </td>`;
            });
        }

        function editEmployee(index) {
            const emp = employees[index];
            document.getElementById('empId').value = emp.id;
            document.getElementById('empName').value = emp.name;
            document.getElementById('empType').value = emp.type;
            document.getElementById('empSalary').value = emp.salary;
            document.getElementById('empEmail').value = emp.email;
            document.getElementById('empAccount').value = emp.account;
            document.getElementById('empId').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function deleteEmployee(index) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${employees[index].name} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                const deletedName = employees[index].name;
                employees.splice(index, 1);
                updateEmployeeTable();
                showMessage('employees', `‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${deletedName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'info');
                saveEmployeesToLocal();
            }
        }

        function loadSampleEmployees() {
            employees = [
                { id: '35', name: 'Ton Yy', salary: 30000, type: 'monthly', email: 'ton@company.com', account: '111-2-33333-4' },
                { id: '34', name: 'Seasakun Phoraya', salary: 25000, type: 'monthly', email: 'seasakun@company.com', account: '111-2-44444-5' },
                { id: '26', name: 'Thanakorn Khotchompoo', salary: 450, type: 'daily', email: 'thanakorn@company.com', account: '111-2-55555-6' }
            ];
            updateEmployeeTable();
            showMessage('employees', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 3 ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        }

        // --- Payroll Calculation ---
        // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô calculatePayroll ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ***
        function calculatePayroll() {
            // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ
            const payrollMonthInput = document.getElementById('report_month').value || document.getElementById('calculate_month').value;
            
            if (!payrollMonthInput) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì');
                return;
            }
            if (employees.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            if (timeRecords.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            payrollResults = [];
            
            employees.forEach(emp => {
                const empTimeRecords = timeRecords.filter(record => {
                    if (record.id !== emp.id || !record.date || !record.date.includes('/')) {
                        return false;
                    }
                    
                    const dateParts = record.date.split('/');
                    if (dateParts.length !== 3) return false;

                    const month = dateParts[1];
                    const year = dateParts[2];

                    if (year.length !== 4) return false;

                    const monthPadded = month.padStart(2, '0');
                    const recordMonthYear = `${year}-${monthPadded}`;
                    
                    return recordMonthYear === payrollMonthInput;
                });
                
                let totalWorkDays = empTimeRecords.length;
                let totalOtHours = 0;
                let totalWorkHours = 0;
                let avgCheckInTime = '';
                
                if (empTimeRecords.length > 0) {
                    let checkInTimes = [];
                    empTimeRecords.forEach(record => {
                        if (record.timeIn && record.timeOut && record.timeIn !== record.timeOut) {
                            const timeIn = parseTime(record.timeIn);
                            const timeOut = parseTime(record.timeOut);
                            let workHours = (timeOut - timeIn) / 3600000;
                            
                            if (workHours < 0) workHours += 24;
                            if (workHours > 6) workHours -= 1;
                            totalWorkHours += workHours;
                            if (workHours > 8) {
                                totalOtHours += (workHours - 8);
                            }
                            checkInTimes.push(record.timeIn);
                        }
                    });
                    
                    if (checkInTimes.length > 0) {
                        const avgMinutes = checkInTimes.reduce((sum, time) => {
                            const [h, m] = time.split(':').map(n => parseInt(n));
                            return sum + (h * 60 + m);
                        }, 0) / checkInTimes.length;
                        
                        const hours = Math.floor(avgMinutes / 60);
                        const minutes = Math.round(avgMinutes % 60);
                        avgCheckInTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    }
                }
                
                let grossSalary = (emp.type === 'monthly') ? emp.salary : emp.salary * totalWorkDays;
                const hourlyRate = (emp.type === 'monthly' ? emp.salary / 30 : emp.salary) / 8;
                const otPay = totalOtHours * hourlyRate * 1.5;
                const totalSalary = grossSalary + otPay;
                
                payrollResults.push({
                    id: emp.id, name: emp.name, workDays: totalWorkDays, workHours: totalWorkHours, otHours: totalOtHours,
                    grossSalary: grossSalary, otPay: otPay, totalSalary: totalSalary, avgCheckIn: avgCheckInTime
                });
            });

            updateReportTable();
            updateReportSummary();
            showCalculationResults();
            showMessage('calculate', '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
        }

        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(n => parseInt(n));
            const date = new Date();
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        function showCalculationResults() {
            const resultDiv = document.getElementById('calculationResult');
            if (!resultDiv || payrollResults.length === 0) return;
            
            const totalEmployees = payrollResults.length;
            const totalSalary = payrollResults.reduce((sum, r) => sum + r.totalSalary, 0);
            const totalOT = payrollResults.reduce((sum, r) => sum + r.otHours, 0);
            
            const resultHTML = `
                <div class="success">‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</div>
                <div class="summary-cards" style="margin-top: 20px;">
                    <div class="card"><h3>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3><div class="value">${totalEmployees} ‡∏Ñ‡∏ô</div></div>
                    <div class="card"><h3>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°</h3><div class="value">${totalSalary.toLocaleString('th-TH', { minimumFractionDigits: 2 })} ‡∏ø</div></div>
                    <div class="card"><h3>OT ‡∏£‡∏ß‡∏°</h3><div class="value">${totalOT.toFixed(1)} ‡∏ä‡∏°.</div></div>
                </div>`;
            resultDiv.innerHTML = resultHTML;
        }

        // --- Reports ---
        function updateReportSummary() {
            const totalEmployeesElem = document.getElementById('totalEmployees');
            const totalSalaryElem = document.getElementById('totalSalary');
            const totalOTElem = document.getElementById('totalOT');
            const avgWorkDaysElem = document.getElementById('avgWorkDays');

            if (totalEmployeesElem) totalEmployeesElem.textContent = `${employees.length} ‡∏Ñ‡∏ô`;

            if (payrollResults.length > 0) {
                const totalSalary = payrollResults.reduce((sum, r) => sum + r.totalSalary, 0);
                const totalOT = payrollResults.reduce((sum, r) => sum + r.otHours, 0);
                const totalDays = payrollResults.reduce((sum, r) => sum + r.workDays, 0);
                const avgDays = employees.length > 0 ? (totalDays / employees.length) : 0;
                
                if (totalSalaryElem) totalSalaryElem.textContent = `${totalSalary.toLocaleString('th-TH', { minimumFractionDigits: 2 })} ‡∏ø`;
                if (totalOTElem) totalOTElem.textContent = `${totalOT.toFixed(1)} ‡∏ä‡∏°.`;
                if (avgWorkDaysElem) avgWorkDaysElem.textContent = `${avgDays.toFixed(1)} ‡∏ß‡∏±‡∏ô`;
            } else {
                if (totalSalaryElem) totalSalaryElem.textContent = `0.00 ‡∏ø`;
                if (totalOTElem) totalOTElem.textContent = `0 ‡∏ä‡∏°.`;
                if (avgWorkDaysElem) avgWorkDaysElem.textContent = `0 ‡∏ß‡∏±‡∏ô`;
            }
        }

        function updateReportTable() {
            const tableBody = document.getElementById('reportTable');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (payrollResults.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</td></tr>`;
                return;
            }

            payrollResults.forEach(result => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${result.id}</td><td>${result.name}</td><td>${result.workDays} ‡∏ß‡∏±‡∏ô</td><td>${result.workHours.toFixed(1)} ‡∏ä‡∏°.</td><td>${result.otHours.toFixed(1)} ‡∏ä‡∏°.</td><td>${result.grossSalary.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td><td>${result.otPay.toFixed(2)}</td><td><strong>${result.totalSalary.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</strong></td><td>${result.avgCheckIn || '-'}</td>`;
            });
        }

        // --- Bank File Generation ---
        function generateBankFile() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
        function generateKBankFile(c, n, d) { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
        function generateSCBFile(c, n, d) { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
        function generateGenericFile(c, n, d) { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
        function previewBankFile() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
        function generatePayslips() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
        function sendAllPayslips() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
        function exportCalculation() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
        function exportReport() { exportCalculation(); }
        function printReport() { window.print(); }

        // --- Utility Functions ---
        function showMessage(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            if (!container) return;
            const existingMessages = container.querySelectorAll('.info, .success, .error');
            existingMessages.forEach(msg => msg.remove());
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = message;
            container.insertBefore(messageDiv, container.firstChild);
            setTimeout(() => { if (messageDiv.parentNode) { messageDiv.remove(); } }, 5000);
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            loadEmployeesFromLocal();
            const today = new Date();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            const defaultMonth = `${year}-${month}`;
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ä‡πà‡∏≠‡∏á
            document.getElementById('calculate_month').value = defaultMonth;
            document.getElementById('report_month').value = defaultMonth;
            
            updateEmployeeTable();
            updateReportSummary();
        });
    </script>
</body>
</html>